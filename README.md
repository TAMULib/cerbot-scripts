# cerbot-scripts
Python scripts that integrate with certbot.

# certbot-infoblox.py
Uses [ACME DNS-01 Challenge](https://letsencrypt.org/docs/challenge-types/) to renew and generate certificates using Infoblox's DNS API. The account used for API access MUST have permissions to create, edit, and delete TXT records. This challenge method allows for the generation or renewal of Wildcard certificates (e.g. *.example.com). To make this script work with other DNS providers, all you need to edit are the 'set_acme_record' and 'delete_acme_record' functions.

**Requirements:**
- python3 (default at /usr/bin/python3, change line 1 of script to match 'which python3'.
- certbot
- openssl

The process of the script is as follows:

1.  Read the contents of the file located at DOMAIN_LIST_PATH. For each line in the file, 1 certificate will be generated for its corresponding domain(s). For example, a certificate for 'sub.example.com' can be generated by simply adding a single line to the DOMAIN_LIST_PATH file reading 'sub.example.com'. As another example, a certificate for both 'proxy1.example.com' AND 'proxy2.example.com' can be generated by adding a single line to the DOMAIN_LIST_PATH file reading 'proxy1.example.com,proxy2.example.com'.

2. The script will then iterate through the list of domains, where it will check if the certificate already exists within the CERT_DIR directory. If it does exists, then the script will call openssl to verify if the script will expire within the REPLACE_AFTER_SECONDS timeframe. If the certificate is expiring before REPLACE_AFTER_SECONDS, or does NOT exist, then it will proceed with the next steps.

3. The script will execute the 'certbot' program to obtain the needed challenge texts and record names, then reach out to Infoblox to create the appropriate records. Once the records are created, the script will wait DELAY_SECONDS seconds to allow DNS to propagate before triggering certbot to verify the challenge data. 

4. If the renewal completes successfully, then the script will rename the old certificate+private key files, copy the new certificate file and private key to the CERT_DIR directory, set the file ownership to CERT_OWNER and CERT_GROUP, and then all records the script created in Infoblox.

5. Once all certificates have been renewed (or attempted to be renewed), the script will then check if the certificate has a "post-script" file within the POST_SCRIPTS_DIR directory. For example, if we renewed the certificate for "*.example.com", then it will look for a file named "_.example.com.sh" within the POST_SCRIPTS_DIR directory. If the script exists, it will execute it. This is where certificated are converted from PEM to PFX (if necessary), and also where certificates are distributed to the services that need them.

6. A summary alert e-mail will be sent to the email set as CONTACT_EMAIL.

# certbot-cloudflare.py
Same as 'cerbot-infoblox.py' but with modified 'set_acme_record' and 'delete_acme_record' functions to work with the Cloudflare API. This one is currently untested.
